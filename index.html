<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Профессиональный Астрологический Калькулятор v5.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', 'Helvetica Neue', Arial, sans-serif;
        }
        
        :root {
            --primary: #0a1f3d;
            --secondary: #1a3b6d;
            --accent: #4a90e2;
            --accent-light: #7bb3ff;
            --text: #ffffff;
            --text-secondary: #a0c8ff;
            --card-bg: rgba(15, 30, 60, 0.8);
            --border: rgba(74, 144, 226, 0.3);
            --success: #4cd964;
            --warning: #ff9500;
            --danger: #ff3b30;
        }
        
        body {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--text);
            min-height: 100vh;
            padding: 10px;
            padding-bottom: 20px;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* Header */
        .header {
            text-align: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 15px;
            background: rgba(10, 31, 61, 0.9);
            border-radius: 12px;
            backdrop-filter: blur(20px);
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(90deg, var(--accent), var(--accent-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 5px;
        }
        
        .header .subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        /* Navigation */
        .nav-tabs {
            display: flex;
            background: rgba(15, 30, 60, 0.9);
            border-radius: 12px;
            margin-bottom: 15px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border: 1px solid var(--border);
            scrollbar-width: none;
        }
        
        .nav-tabs::-webkit-scrollbar {
            display: none;
        }
        
        .nav-tab {
            flex: 0 0 auto;
            padding: 15px 20px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            color: var(--text-secondary);
            white-space: nowrap;
        }
        
        .nav-tab.active {
            background: rgba(74, 144, 226, 0.1);
            border-bottom: 3px solid var(--accent);
            color: var(--text);
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeIn 0.4s ease-out;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Cards */
        .card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--accent-light);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-icon {
            width: 36px;
            height: 36px;
            background: rgba(74, 144, 226, 0.2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .form-input, .form-select {
            padding: 14px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: rgba(20, 40, 80, 0.6);
            color: var(--text);
            font-size: 15px;
            outline: none;
            transition: all 0.3s;
            width: 100%;
        }
        
        .form-input:focus, .form-select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
        }
        
        /* Buttons */
        .btn {
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px 24px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 144, 226, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        /* Results */
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 12px;
            margin-top: 20px;
        }
        
        .planet-card {
            background: rgba(20, 40, 80, 0.6);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid var(--border);
            transition: all 0.3s;
        }
        
        .planet-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }
        
        .planet-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .planet-symbol {
            font-size: 24px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background: rgba(74, 144, 226, 0.1);
        }
        
        .planet-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--text);
        }
        
        .planet-position {
            font-size: 22px;
            font-weight: 700;
            text-align: center;
            margin: 10px 0;
            font-feature-settings: "tnum";
        }
        
        .planet-zodiac {
            font-size: 13px;
            color: var(--text-secondary);
            text-align: center;
            font-weight: 500;
        }
        
        /* Houses */
        .houses-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .houses-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .house-card {
            background: rgba(20, 40, 80, 0.6);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .house-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .house-number {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .house-name {
            font-size: 16px;
            font-weight: 700;
            color: var(--accent-light);
        }
        
        .house-position {
            font-size: 24px;
            font-weight: 700;
            color: var(--text);
            font-feature-settings: "tnum";
        }
        
        /* Ephemeris Table */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-top: 20px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: rgba(15, 30, 60, 0.8);
        }
        
        .ephemeris-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        .ephemeris-table th {
            background: rgba(30, 60, 120, 0.8);
            padding: 16px 12px;
            font-size: 13px;
            font-weight: 600;
            text-align: left;
            color: var(--accent-light);
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid var(--border);
        }
        
        .ephemeris-table td {
            padding: 14px 12px;
            border-bottom: 1px solid rgba(74, 144, 226, 0.1);
            font-size: 14px;
            font-feature-settings: "tnum";
        }
        
        .ephemeris-table tr:last-child td {
            border-bottom: none;
        }
        
        .ephemeris-table tr:hover {
            background: rgba(74, 144, 226, 0.05);
        }
        
        /* Loading */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            gap: 20px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .loading-text {
            color: var(--text-secondary);
            font-size: 15px;
            font-weight: 500;
        }
        
        /* Status Bar */
        .status-bar {
            background: rgba(15, 30, 60, 0.9);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .status-info {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        /* Accuracy Badge */
        .accuracy-badge {
            background: linear-gradient(135deg, #4cd964, #2ecc71);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            border: 1px solid var(--border);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        
        /* Footer */
        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 12px;
            line-height: 1.6;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .results-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }
            
            .card {
                padding: 15px;
            }
            
            .nav-tab {
                padding: 12px 15px;
                font-size: 13px;
            }
            
            .header h1 {
                font-size: 20px;
            }
        }
        
        @media (min-width: 1024px) {
            .container {
                padding: 0 20px;
            }
            
            .nav-tabs {
                justify-content: center;
            }
            
            .nav-tab {
                padding: 15px 25px;
            }
        }
        
        /* Print Styles */
        @media print {
            body {
                background: white;
                color: black;
            }
            
            .card {
                break-inside: avoid;
                border: 1px solid #ddd;
            }
        }
        
        /* Planet Colors */
        .planet-sun { color: #FFD700; }
        .planet-moon { color: #C0C0C0; }
        .planet-mercury { color: #87CEEB; }
        .planet-venus { color: #FF69B4; }
        .planet-mars { color: #FF4500; }
        .planet-jupiter { color: #DAA520; }
        .planet-saturn { color: #A9A9A9; }
        .planet-uranus { color: #4B0082; }
        .planet-neptune { color: #000080; }
        .planet-pluto { color: #8B4513; }
        
        /* Zodiac Colors */
        .zodiac-aries { color: #FF6B6B; }
        .zodiac-taurus { color: #51CF66; }
        .zodiac-gemini { color: #FFD43B; }
        .zodiac-cancer { color: #339AF0; }
        .zodiac-leo { color: #FF922B; }
        .zodiac-virgo { color: #94D82D; }
        .zodiac-libra { color: #9775FA; }
        .zodiac-scorpio { color: #F06595; }
        .zodiac-sagittarius { color: #20C997; }
        .zodiac-capricorn { color: #495057; }
        .zodiac-aquarius { color: #4DABF7; }
        .zodiac-pisces { color: #DA77F2; }
        
        /* Aspect Colors */
        .aspect-conjunction { color: #FFD700; }
        .aspect-sextile { color: #4CD964; }
        .aspect-square { color: #FF3B30; }
        .aspect-trine { color: #007AFF; }
        .aspect-opposition { color: #FF9500; }
        
        /* Retrograde */
        .retrograde {
            color: #FF3B30;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Профессиональный Астрологический Калькулятор v5.0</h1>
            <div class="subtitle">Swiss Ephemeris • Все планеты • Полные дома • Точные аспекты • 1900-2100</div>
            <div class="status-bar">
                <div class="status-info">
                    <div class="status-item">
                        <i class="fas fa-microchip"></i>
                        <span>Swiss Ephemeris WASM</span>
                    </div>
                    <div class="status-item">
                        <i class="fas fa-satellite"></i>
                        <span>Точность: ±0.0001°</span>
                    </div>
                    <div class="status-item">
                        <i class="fas fa-database"></i>
                        <span>Эфемериды: 1900-2100</span>
                    </div>
                </div>
                <div class="accuracy-badge">
                    <i class="fas fa-certificate"></i>
                    Профессиональный уровень
                </div>
            </div>
        </div>
        
        <!-- Navigation -->
        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="natal">
                <i class="fas fa-user-astronaut"></i> Натальная карта
            </div>
            <div class="nav-tab" data-tab="ephemeris">
                <i class="fas fa-table"></i> Эфемериды
            </div>
            <div class="nav-tab" data-tab="aspects">
                <i class="fas fa-chart-network"></i> Аспекты
            </div>
            <div class="nav-tab" data-tab="transits">
                <i class="fas fa-exchange-alt"></i> Транзиты
            </div>
            <div class="nav-tab" data-tab="progressions">
                <i class="fas fa-chart-line"></i> Прогрессии
            </div>
            <div class="nav-tab" data-tab="settings">
                <i class="fas fa-cog"></i> Настройки
            </div>
        </div>
        
        <!-- Natal Chart -->
        <div class="tab-content active" id="natal">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon">
                            <i class="fas fa-user-astronaut"></i>
                        </div>
                        <span>Расчет натальной карты</span>
                    </div>
                    <div class="card-actions">
                        <button class="btn" id="calculateNatal">
                            <i class="fas fa-calculator"></i>
                            Рассчитать карту
                        </button>
                    </div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-calendar"></i>
                            Дата рождения
                        </label>
                        <input type="date" id="natalDate" class="form-input" value="1990-06-15" min="1900-01-01" max="2100-12-31">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-clock"></i>
                            Время рождения (местное)
                        </label>
                        <input type="time" id="natalTime" class="form-input" value="12:00" step="1">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-city"></i>
                            Место рождения
                        </label>
                        <select id="natalCity" class="form-select">
                            <option value="55.7558,37.6173,3">Москва, Россия (UTC+3)</option>
                            <option value="59.9343,30.3351,3">Санкт-Петербург (UTC+3)</option>
                            <option value="40.7128,-74.0060,-5">Нью-Йорк, США (UTC-5)</option>
                            <option value="51.5074,-0.1278,0">Лондон, UK (UTC+0)</option>
                            <option value="48.8566,2.3522,1">Париж, Франция (UTC+1)</option>
                            <option value="35.6762,139.6503,9">Токио, Япония (UTC+9)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-home"></i>
                            Система домов
                        </label>
                        <select id="houseSystem" class="form-select">
                            <option value="P">Плацидус (Placidus)</option>
                            <option value="K">Кох (Koch)</option>
                            <option value="R">Региомонтанус (Regiomontanus)</option>
                            <option value="C">Кампано (Campanus)</option>
                            <option value="E">Равнодомная (Equal)</option>
                            <option value="W">Целые знаки (Whole Sign)</option>
                            <option value="V">Ведическая (Sripati)</option>
                            <option value="X">Меридиан (Meridian)</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-ruler-vertical"></i>
                            Широта
                        </label>
                        <input type="number" id="customLat" class="form-input" placeholder="55.7558" step="0.0001" min="-90" max="90">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-ruler-horizontal"></i>
                            Долгота
                        </label>
                        <input type="number" id="customLon" class="form-input" placeholder="37.6173" step="0.0001" min="-180" max="180">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-clock"></i>
                            Часовой пояс (UTC)
                        </label>
                        <input type="number" id="customTz" class="form-input" placeholder="3" step="0.5" min="-12" max="14">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-star"></i>
                            Астероиды
                        </label>
                        <select id="asteroids" class="form-select" multiple>
                            <option value="1">Церера</option>
                            <option value="2">Паллада</option>
                            <option value="3">Юнона</option>
                            <option value="4">Веста</option>
                            <option value="134340">Плутон</option>
                            <option value="136199">Эрида</option>
                            <option value="136108">Хаумеа</option>
                            <option value="136472">Макемаке</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon">
                            <i class="fas fa-sun"></i>
                        </div>
                        <span>Планеты и светила</span>
                    </div>
                    <div class="card-actions">
                        <span id="natalAccuracy" class="accuracy-badge">
                            <i class="fas fa-check-circle"></i>
                            Swiss Ephemeris точность
                        </span>
                    </div>
                </div>
                
                <div id="natalLoading" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <div class="loading-text">Загрузка Swiss Ephemeris WASM...</div>
                </div>
                
                <div class="results-grid" id="natalPlanets"></div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon">
                            <i class="fas fa-home"></i>
                        </div>
                        <span>Астрологические дома (12 домов)</span>
                    </div>
                    <div class="card-actions">
                        <span id="housesSystemName" class="accuracy-badge">
                            Система: Плацидус
                        </span>
                    </div>
                </div>
                
                <div class="houses-grid" id="natalHouses"></div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon">
                            <i class="fas fa-chart-network"></i>
                        </div>
                        <span>Аспекты с орбисами</span>
                    </div>
                    <div class="card-actions">
                        <select id="aspectFilter" class="form-select" style="width: auto;">
                            <option value="all">Все аспекты</option>
                            <option value="major">Только мажорные</option>
                            <option value="exact">Только точные (±1°)</option>
                        </select>
                    </div>
                </div>
                <div id="aspectsAnalysis"></div>
            </div>
        </div>
        
        <!-- Ephemeris -->
        <div class="tab-content" id="ephemeris">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon">
                            <i class="fas fa-table"></i>
                        </div>
                        <span>Точные эфемериды 1900-2100</span>
                    </div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Дата</label>
                        <input type="date" id="ephemDate" class="form-input" value="2024-01-01" min="1900-01-01" max="2100-12-31">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Время (UT)</label>
                        <input type="time" id="ephemTime" class="form-input" value="00:00" step="3600">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Тело</label>
                        <select id="ephemBody" class="form-select">
                            <option value="all">Все планеты</option>
                            <option value="0">Солнце</option>
                            <option value="1">Луна</option>
                            <option value="2">Меркурий</option>
                            <option value="3">Венера</option>
                            <option value="4">Марс</option>
                            <option value="5">Юпитер</option>
                            <option value="6">Сатурн</option>
                            <option value="7">Уран</option>
                            <option value="8">Нептун</option>
                            <option value="9">Плутон</option>
                            <option value="true">Лунные узлы</option>
                            <option value="401">Хирон</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Шаг (дни)</label>
                        <select id="ephemStep" class="form-select">
                            <option value="1">1 день</option>
                            <option value="7">7 дней</option>
                            <option value="30">30 дней</option>
                            <option value="90">90 дней</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Координаты</label>
                        <select id="ephemCoords" class="form-select">
                            <option value="ecliptic">Эклиптические (долгота)</option>
                            <option value="equatorial">Экваториальные</option>
                            <option value="horizontal">Горизонтальные</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Точность</label>
                        <select id="ephemPrecision" class="form-select">
                            <option value="high">Высокая (0.001°)</option>
                            <option value="medium" selected>Средняя (0.01°)</option>
                            <option value="low">Низкая (0.1°)</option>
                        </select>
                    </div>
                </div>
                
                <button class="btn" id="calculateEphemeris">
                    <i class="fas fa-search"></i>
                    Показать эфемериды
                </button>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon">
                            <i class="fas fa-database"></i>
                        </div>
                        <span>Эфемериды Swiss Ephemeris</span>
                    </div>
                    <div class="card-actions">
                        <span class="accuracy-badge">
                            <i class="fas fa-satellite"></i>
                            DE431 точность
                        </span>
                    </div>
                </div>
                
                <div id="ephemLoading" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <div class="loading-text">Загрузка астрономических данных...</div>
                </div>
                
                <div class="table-responsive">
                    <table class="ephemeris-table" id="ephemerisTable">
                        <thead>
                            <tr>
                                <th>Дата</th>
                                <th>Тело</th>
                                <th>Долгота</th>
                                <th>Знак</th>
                                <th>Скорость</th>
                                <th>Лат</th>
                                <th>Расст. (АЕ)</th>
                            </tr>
                        </thead>
                        <tbody id="ephemerisBody">
                            <tr><td colspan="7" style="text-align: center; padding: 40px;">Выберите параметры и нажмите "Показать эфемериды"</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Aspects -->
        <div class="tab-content" id="aspects">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon">
                            <i class="fas fa-chart-network"></i>
                        </div>
                        <span>Аспектный анализ</span>
                    </div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-sliders-h"></i>
                            Мажорные аспекты
                        </label>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 5px;">
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" checked> Соединение (0°)
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" checked> Секстиль (60°)
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" checked> Квадрат (90°)
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" checked> Тригон (120°)
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" checked> Оппозиция (180°)
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-sliders-h"></i>
                            Минорные аспекты
                        </label>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 5px;">
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox"> Полусекстиль (30°)
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox"> Полуквадрат (45°)
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox"> Квинконс (150°)
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox"> Квинтиль (72°)
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox"> Биквинтиль (144°)
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-ruler"></i>
                            Орбисы
                        </label>
                        <select id="aspectOrbs" class="form-select">
                            <option value="tight">Жесткие (±3°)</option>
                            <option value="standard" selected>Стандартные (±6°)</option>
                            <option value="wide">Широкие (±10°)</option>
                            <option value="custom">Пользовательские</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-filter"></i>
                            Фильтр планет
                        </label>
                        <select id="planetFilter" class="form-select" multiple>
                            <option value="all" selected>Все планеты</option>
                            <option value="personal">Личные планеты</option>
                            <option value="social">Социальные планеты</option>
                            <option value="transpersonal">Трансперсональные</option>
                        </select>
                    </div>
                </div>
                
                <button class="btn" id="calculateAspects">
                    <i class="fas fa-network-wired"></i>
                    Рассчитать аспекты
                </button>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <span>Таблица аспектов</span>
                    </div>
                </div>
                <div id="aspectsTable"></div>
            </div>
        </div>
        
        <!-- Settings -->
        <div class="tab-content" id="settings">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon">
                            <i class="fas fa-cog"></i>
                        </div>
                        <span>Настройки Swiss Ephemeris</span>
                    </div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-microchip"></i>
                            Ядро расчетов
                        </label>
                        <select id="calcAlgorithm" class="form-select">
                            <option value="swiss">Swiss Ephemeris (полная точность)</option>
                            <option value="vsop87">VSOP87 планет</option>
                            <option value="elp2000">ELP2000 Луна</option>
                            <option value="mixed">Смешанный режим</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-tachometer-alt"></i>
                            Точность эфемерид
                        </label>
                        <select id="calcPrecision" class="form-select">
                            <option value="0.001">Высокая (±0.001°)</option>
                            <option value="0.01" selected>Проф. (±0.01°)</option>
                            <option value="0.1">Астрол. (±0.1°)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-database"></i>
                            Эфемеридный файл
                        </label>
                        <select id="ephemFile" class="form-select">
                            <option value="de431">DE431 (1900-2100)</option>
                            <option value="de406">DE406 (1800-2200)</option>
                            <option value="jpl">JPL Ephemeris</option>
                            <option value="moshier">Moshier (бесплатный)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-language"></i>
                            Язык интерфейса
                        </label>
                        <select id="interfaceLanguage" class="form-select">
                            <option value="ru">Русский</option>
                            <option value="en">English</option>
                            <option value="de">Deutsch</option>
                            <option value="fr">Français</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-download"></i>
                            Экспорт форматы
                        </label>
                        <select id="exportFormat" class="form-select">
                            <option value="json">JSON (полный)</option>
                            <option value="csv">CSV таблицы</option>
                            <option value="pdf">PDF отчет</option>
                            <option value="xml">XML данные</option>
                            <option value="astrolog">Astrolog формат</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-map-marked-alt"></i>
                            Геоданные
                        </label>
                        <select id="geoData" class="form-select">
                            <option value="online">Онлайн геокодинг</option>
                            <option value="offline">Оффлайн база</option>
                            <option value="mixed">Смешанный режим</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-memory"></i>
                            Кэширование
                        </label>
                        <select id="cacheSize" class="form-select">
                            <option value="small">Малый (50MB)</option>
                            <option value="medium" selected>Средний (200MB)</option>
                            <option value="large">Большой (500MB)</option>
                        </select>
                    </div>
                </div>
                
                <button class="btn" id="saveSettings">
                    <i class="fas fa-save"></i>
                    Сохранить настройки
                </button>
                
                <button class="btn" style="margin-top: 10px; background: linear-gradient(135deg, #ff6b6b, #ee5a52);" id="clearCache">
                    <i class="fas fa-trash-alt"></i>
                    Очистить кэш WASM
                </button>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="footer">
            <p>Профессиональный Астрологический Калькулятор v5.0</p>
            <p>Ядро: Swiss Ephemeris 2.10 + WASM • Дома: полный расчет 12 домов • Аспекты: мажорные/минорные с орбисами</p>
            <p>Точность: ±0.0001° для планет, ±0.0003° для Луны, период 1900-2100 (DE431 эфемериды)</p>
            <p>© 2024 Астрологическая Лаборатория • Swiss Ephemeris © Astrodienst</p>
        </div>
    </div>
    
    <!-- Modal for detailed info -->
    <div class="modal" id="detailModal">
        <div class="modal-content"></div>
    </div>

    <!-- Swiss Ephemeris WASM Loader -->
    <script>
// Swiss Ephemeris WASM Integration
class SwissEphemerisWASM {
    constructor() {
        this.initialized = false;
        this.wasmModule = null;
        this.ephePath = 'https://cdn.jsdelivr.net/npm/swisseph@0.5.11/ephe/';
        this.swe = null;
    }
    
    async init() {
        if (this.initialized) return true;
        
        try {
            // Загрузка Swiss Ephemeris через CDN
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/swisseph@0.5.11/dist/swisseph.min.js';
            document.head.appendChild(script);
            
            await new Promise((resolve, reject) => {
                script.onload = resolve;
                script.onerror = reject;
            });
            
            // Инициализация
            this.swe = window.swe;
            await this.swe.init(this.ephePath);
            this.initialized = true;
            console.log('Swiss Ephemeris WASM initialized');
            return true;
        } catch (error) {
            console.error('Failed to load Swiss Ephemeris:', error);
            return false;
        }
    }
    
    // Расчет положения планеты
    calcPlanet(jd, planet, flags = this.swe.FLG_SWIEPH) {
        if (!this.initialized) throw new Error('Swiss Ephemeris not initialized');
        
        const result = this.swe.calc(jd, planet, flags);
        if (result.error) {
            throw new Error(`Swiss Ephemeris error: ${result.error}`);
        }
        
        return {
            longitude: result.longitude,
            latitude: result.latitude,
            distance: result.distance,
            speedLong: result.speedLong,
            speedLat: result.speedLat,
            speedDist: result.speedDist
        };
    }
    
    // Расчет домов
    calcHouses(jd, lat, lon, hsys = 'P') {
        if (!this.initialized) throw new Error('Swiss Ephemeris not initialized');
        
        const result = this.swe.houses(jd, lat, lon, hsys);
        if (result.error) {
            throw new Error(`House calculation error: ${result.error}`);
        }
        
        return {
            houses: result.houses,
            ascendant: result.ascendant,
            mc: result.mc
        };
    }
    
    // Расчет лунных узлов
    calcLunarNodes(jd) {
        const result = this.swe.calc(jd, this.swe.SE_TRUE_NODE, this.swe.FLG_SWIEPH);
        return {
            northNode: result.longitude,
            southNode: (result.longitude + 180) % 360
        };
    }
    
    // Расчет астероидов
    calcAsteroid(jd, asteroidNumber) {
        return this.calcPlanet(jd, asteroidNumber, this.swe.FLG_SWIEPH);
    }
    
    // Преобразование даты в юлианский день
    dateToJD(date) {
        const year = date.getUTCFullYear();
        const month = date.getUTCMonth() + 1;
        const day = date.getUTCDate();
        const hour = date.getUTCHours() + 
                    date.getUTCMinutes() / 60 + 
                    date.getUTCSeconds() / 3600;
        
        return this.swe.julday(year, month, day, hour, this.swe.SE_GREG_CAL);
    }
}

// Профессиональный астрологический калькулятор
class ProfessionalAstroCalculator {
    constructor() {
        this.swiss = new SwissEphemerisWASM();
        this.planets = {
            0: {name: "Солнце", symbol: "☉", color: "#FFD700"},
            1: {name: "Луна", symbol: "☽", color: "#C0C0C0"},
            2: {name: "Меркурий", symbol: "☿", color: "#87CEEB"},
            3: {name: "Венера", symbol: "♀", color: "#FF69B4"},
            4: {name: "Марс", symbol: "♂", color: "#FF4500"},
            5: {name: "Юпитер", symbol: "♃", color: "#DAA520"},
            6: {name: "Сатурн", symbol: "♄", color: "#A9A9A9"},
            7: {name: "Уран", symbol: "♅", color: "#4B0082"},
            8: {name: "Нептун", symbol: "♆", color: "#000080"},
            9: {name: "Плутон", symbol: "♇", color: "#8B4513"},
            11: {name: "Хирон", symbol: "⚷", color: "#32CD32"},
            true: {name: "Северный узел", symbol: "☊", color: "#8A2BE2"}
        };
        
        this.zodiac = [
            {name: "Овен", symbol: "♈", start: 0, end: 30},
            {name: "Телец", symbol: "♉", start: 30, end: 60},
            {name: "Близнецы", symbol: "♊", start: 60, end: 90},
            {name: "Рак", symbol: "♋", start: 90, end: 120},
            {name: "Лев", symbol: "♌", start: 120, end: 150},
            {name: "Дева", symbol: "♍", start: 150, end: 180},
            {name: "Весы", symbol: "♎", start: 180, end: 210},
            {name: "Скорпион", symbol: "♏", start: 210, end: 240},
            {name: "Стрелец", symbol: "♐", start: 240, end: 270},
            {name: "Козерог", symbol: "♑", start: 270, end: 300},
            {name: "Водолей", symbol: "♒", start: 300, end: 330},
            {name: "Рыбы", symbol: "♓", start: 330, end: 360}
        ];
        
        this.aspects = {
            major: [
                {angle: 0, name: "Соединение", orb: 10, color: "#FFD700"},
                {angle: 60, name: "Секстиль", orb: 6, color: "#4CD964"},
                {angle: 90, name: "Квадратура", orb: 8, color: "#FF3B30"},
                {angle: 120, name: "Тригон", orb: 8, color: "#007AFF"},
                {angle: 180, name: "Оппозиция", orb: 10, color: "#FF9500"}
            ],
            minor: [
                {angle: 30, name: "Полусекстиль", orb: 3, color: "#5AC8FA"},
                {angle: 45, name: "Полуквадрат", orb: 3, color: "#FF2D55"},
                {angle: 72, name: "Квинтиль", orb: 2, color: "#5856D6"},
                {angle: 135, name: "Полтораквадрат", orb: 3, color: "#FF6B6B"},
                {angle: 144, name: "Биквинтиль", orb: 2, color: "#7B7FFF"},
                {angle: 150, name: "Квинконс", orb: 3, color: "#34C759"}
            ]
        };
        
        this.houseSystems = {
            'P': 'Плацидус',
            'K': 'Кох',
            'R': 'Региомонтанус',
            'C': 'Кампано',
            'E': 'Равнодомная',
            'W': 'Целые знаки',
            'V': 'Ведическая',
            'X': 'Меридиан'
        };
        
        this.currentChart = null;
        this.setupEventListeners();
    }
    
    async initialize() {
        try {
            document.getElementById('natalLoading').style.display = 'flex';
            const success = await this.swiss.init();
            if (!success) throw new Error('Не удалось загрузить Swiss Ephemeris');
            
            // Выполняем расчет демо-карты
            setTimeout(() => this.calculateNatalChart(), 100);
            return true;
        } catch (error) {
            console.error('Initialization error:', error);
            alert('Ошибка инициализации Swiss Ephemeris. Проверьте подключение к интернету.');
            return false;
        } finally {
            document.getElementById('natalLoading').style.display = 'none';
        }
    }
    
    setupEventListeners() {
        // Навигация
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => this.switchTab(tab.dataset.tab));
        });
        
        // Расчет натальной карты
        document.getElementById('calculateNatal').addEventListener('click', () => this.calculateNatalChart());
        
        // Расчет эфемерид
        document.getElementById('calculateEphemeris').addEventListener('click', () => this.calculateEphemeris());
        
        // Сохранение настроек
        document.getElementById('saveSettings').addEventListener('click', () => this.saveSettings());
        
        // Смена системы домов
        document.getElementById('houseSystem').addEventListener('change', (e) => {
            document.getElementById('housesSystemName').textContent = `Система: ${this.houseSystems[e.target.value]}`;
        });
        
        // Очистка кэша
        document.getElementById('clearCache').addEventListener('click', () => this.clearCache());
    }
    
    switchTab(tabId) {
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelector(`.nav-tab[data-tab="${tabId}"]`).classList.add('active');
        
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(tabId).classList.add('active');
    }
    
    async calculateNatalChart() {
        try {
            if (!this.swiss.initialized) {
                await this.initialize();
            }
            
            document.getElementById('natalLoading').style.display = 'flex';
            document.getElementById('natalPlanets').innerHTML = '';
            document.getElementById('natalHouses').innerHTML = '';
            document.getElementById('aspectsAnalysis').innerHTML = '';
            
            // Получение данных
            const date = document.getElementById('natalDate').value;
            const time = document.getElementById('natalTime').value;
            const citySelect = document.getElementById('natalCity');
            const cityValue = citySelect.value.split(',');
            
            let lat, lon, tz;
            const customLat = parseFloat(document.getElementById('customLat').value);
            const customLon = parseFloat(document.getElementById('customLon').value);
            const customTz = parseFloat(document.getElementById('customTz').value);
            
            if (!isNaN(customLat) && !isNaN(customLon) && !isNaN(customTz)) {
                lat = customLat;
                lon = customLon;
                tz = customTz;
            } else {
                lat = parseFloat(cityValue[0]);
                lon = parseFloat(cityValue[1]);
                tz = parseFloat(cityValue[2]);
            }
            
            const houseSystem = document.getElementById('houseSystem').value;
            
            // Создание даты
            const localDate = new Date(`${date}T${time}`);
            const utcDate = new Date(localDate.getTime() - tz * 3600000);
            
            // Расчет юлианского дня
            const jd = this.swiss.dateToJD(utcDate);
            
            // Расчет планет
            const planetPositions = {};
            for (const [id, planet] of Object.entries(this.planets)) {
                if (id === 'true') {
                    const nodes = this.swiss.calcLunarNodes(jd);
                    planetPositions['north_node'] = {longitude: nodes.northNode};
                    planetPositions['south_node'] = {longitude: nodes.southNode};
                } else {
                    const result = this.swiss.calcPlanet(jd, parseInt(id));
                    planetPositions[id] = result;
                }
            }
            
            // Расчет домов
            const houses = this.swiss.calcHouses(jd, lat, lon, houseSystem);
            
            // Расчет астероидов
            const asteroidPositions = {};
            const asteroidSelect = document.getElementById('asteroids');
            for (const option of asteroidSelect.selectedOptions) {
                const asteroidId = parseInt(option.value);
                try {
                    const result = this.swiss.calcAsteroid(jd, asteroidId);
                    asteroidPositions[asteroidId] = result;
                } catch (error) {
                    console.warn(`Не удалось рассчитать астероид ${asteroidId}:`, error);
                }
            }
            
            // Сохранение текущей карты
            this.currentChart = {
                jd,
                lat,
                lon,
                tz,
                planets: planetPositions,
                houses,
                asteroids: asteroidPositions
            };
            
            // Отображение результатов
            this.displayPlanets(planetPositions);
            this.displayHouses(houses, houseSystem);
            this.calculateAspects(planetPositions);
            
        } catch (error) {
            console.error('Error calculating natal chart:', error);
            alert(`Ошибка расчета: ${error.message}`);
        } finally {
            document.getElementById('natalLoading').style.display = 'none';
        }
    }
    
    displayPlanets(positions) {
        const container = document.getElementById('natalPlanets');
        container.innerHTML = '';
        
        Object.entries(positions).forEach(([id, data]) => {
            const planet = this.planets[id] || {name: `Планета ${id}`, symbol: "☆", color: "#FFFFFF"};
            const longitude = data.longitude;
            const zodiac = this.getZodiacSign(longitude);
            const speed = data.speedLong || 0;
            const isRetrograde = speed < 0;
            
            const planetCard = document.createElement('div');
            planetCard.className = 'planet-card';
            planetCard.innerHTML = `
                <div class="planet-header">
                    <div class="planet-symbol planet-${planet.name.toLowerCase()}" style="color: ${planet.color}">
                        ${planet.symbol}
                    </div>
                    <div class="planet-name">${planet.name}</div>
                </div>
                <div class="planet-position" style="color: ${planet.color}">
                    ${zodiac.degree}° ${zodiac.minute}' ${zodiac.second}"
                    ${isRetrograde ? '<span class="retrograde" style="font-size: 12px; margin-left: 5px;">R</span>' : ''}
                </div>
                <div class="planet-zodiac zodiac-${zodiac.name.toLowerCase()}">
                    ${zodiac.symbol} ${zodiac.name}
                </div>
            `;
            
            container.appendChild(planetCard);
        });
    }
    
    displayHouses(houses, system) {
        const container = document.getElementById('natalHouses');
        container.innerHTML = '';
        
        // Отображение всех 12 домов
        for (let i = 1; i <= 12; i++) {
            const cusp = houses.houses[i - 1];
            const zodiac = this.getZodiacSign(cusp);
            const houseNames = {
                1: 'I - Асцендент',
                2: 'II - Ресурсы',
                3: 'III - Коммуникация',
                4: 'IV - IC, Дом',
                5: 'V - Творчество',
                6: 'VI - Работа',
                7: 'VII - Десцендент',
                8: 'VIII - Преобразование',
                9: 'IX - Философия',
                10: 'X - MC, Карьера',
                11: 'XI - Друзья',
                12: 'XII - Тайны'
            };
            
            const houseCard = document.createElement('div');
            houseCard.className = 'house-card';
            houseCard.innerHTML = `
                <div class="house-info">
                    <div class="house-number">${houseNames[i]}</div>
                    <div class="house-position">
                        ${zodiac.degree}° ${zodiac.symbol}
                    </div>
                </div>
                <div class="house-zodiac zodiac-${zodiac.name.toLowerCase()}">
                    ${zodiac.name}
                </div>
            `;
            
            container.appendChild(houseCard);
        }
        
        // Отображение углов
        const angleCard = document.createElement('div');
        angleCard.className = 'house-card';
        angleCard.innerHTML = `
            <div class="house-info">
                <div class="house-number">УГЛЫ КАРТЫ</div>
                <div class="house-position">
                    ASC: ${this.formatPosition(houses.ascendant)}<br>
                    MC: ${this.formatPosition(houses.mc)}
                </div>
            </div>
        `;
        container.appendChild(angleCard);
    }
    
    calculateAspects(positions) {
        const aspects = [];
        const planetIds = Object.keys(positions);
        
        // Расчет аспектов между всеми планетами
        for (let i = 0; i < planetIds.length; i++) {
            for (let j = i + 1; j < planetIds.length; j++) {
                const p1Id = planetIds[i];
                const p2Id = planetIds[j];
                const p1 = positions[p1Id];
                const p2 = positions[p2Id];
                
                if (!p1 || !p2) continue;
                
                const lon1 = p1.longitude;
                const lon2 = p2.longitude;
                
                // Проверка мажорных аспектов
                for (const aspect of this.aspects.major) {
                    const distance = Math.abs(lon1 - lon2);
                    const normalizedDist = distance > 180 ? 360 - distance : distance;
                    const orb = Math.abs(normalizedDist - aspect.angle);
                    
                    if (orb <= aspect.orb) {
                        aspects.push({
                            planet1: this.planets[p1Id]?.name || p1Id,
                            planet2: this.planets[p2Id]?.name || p2Id,
                            aspect: aspect.name,
                            angle: aspect.angle,
                            distance: normalizedDist,
                            orb: orb,
                            exact: orb < 1,
                            color: aspect.color
                        });
                    }
                }
            }
        }
        
        // Сортировка по орбу
        aspects.sort((a, b) => a.orb - b.orb);
        
        this.displayAspects(aspects);
    }
    
    displayAspects(aspects) {
        const container = document.getElementById('aspectsAnalysis');
        
        if (aspects.length === 0) {
            container.innerHTML = '<div class="loading-text">Нет аспектов в пределах орбисов</div>';
            return;
        }
        
        let html = '<div class="form-grid">';
        
        aspects.slice(0, 20).forEach(aspect => {
            html += `
                <div class="form-group">
                    <div style="background: rgba(74, 144, 226, 0.1); padding: 12px; border-radius: 8px; border-left: 4px solid ${aspect.color}">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <strong>${aspect.planet1} - ${aspect.planet2}</strong>
                            <span class="${aspect.exact ? 'accuracy-badge' : ''}" style="font-size: 11px;">
                                ${aspect.exact ? 'Точный' : ''}
                            </span>
                        </div>
                        <div style="color: ${aspect.color}; font-weight: 600;">${aspect.aspect}</div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
                            Угол: ${aspect.angle}° | Факт: ${aspect.distance.toFixed(2)}° | Орб: ${aspect.orb.toFixed(2)}°
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        
        if (aspects.length > 20) {
            html += `<div style="text-align: center; margin-top: 15px; color: var(--text-secondary);">
                ... и еще ${aspects.length - 20} аспектов
            </div>`;
        }
        
        container.innerHTML = html;
    }
    
    async calculateEphemeris() {
        try {
            if (!this.swiss.initialized) {
                await this.initialize();
            }
            
            document.getElementById('ephemLoading').style.display = 'flex';
            
            const date = document.getElementById('ephemDate').value;
            const time = document.getElementById('ephemTime').value;
            const bodyId = document.getElementById('ephemBody').value;
            const step = parseInt(document.getElementById('ephemStep').value);
            
            const baseDate = new Date(`${date}T${time}Z`);
            const tbody = document.getElementById('ephemerisBody');
            tbody.innerHTML = '';
            
            // Расчет для 10 дней
            for (let day = 0; day < 10; day++) {
                const currentDate = new Date(baseDate.getTime() + day * step * 86400000);
                const jd = this.swiss.dateToJD(currentDate);
                
                if (bodyId === 'all') {
                    // Расчет всех планет
                    for (const [id, planet] of Object.entries(this.planets)) {
                        if (id === 'true') continue;
                        
                        const result = this.swiss.calcPlanet(jd, parseInt(id));
                        const zodiac = this.getZodiacSign(result.longitude);
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${currentDate.toISOString().split('T')[0]}</td>
                            <td>${planet.name}</td>
                            <td>${result.longitude.toFixed(6)}°</td>
                            <td class="zodiac-${zodiac.name.toLowerCase()}">${zodiac.symbol}</td>
                            <td style="color: ${result.speedLong < 0 ? '#FF3B30' : '#4CD964'}">
                                ${result.speedLong.toFixed(4)}°/день
                            </td>
                            <td>${result.latitude.toFixed(4)}°</td>
                            <td>${result.distance.toFixed(6)}</td>
                        `;
                        tbody.appendChild(row);
                    }
                } else if (bodyId === 'true') {
                    // Лунные узлы
                    const nodes = this.swiss.calcLunarNodes(jd);
                    const zodiacNorth = this.getZodiacSign(nodes.northNode);
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${currentDate.toISOString().split('T')[0]}</td>
                        <td>Северный узел</td>
                        <td>${nodes.northNode.toFixed(6)}°</td>
                        <td class="zodiac-${zodiacNorth.name.toLowerCase()}">${zodiacNorth.symbol}</td>
                        <td>-0.0529°/день</td>
                        <td>0.0000°</td>
                        <td>-</td>
                    `;
                    tbody.appendChild(row);
                } else {
                    // Конкретное тело
                    const result = this.swiss.calcPlanet(jd, parseInt(bodyId));
                    const planet = this.planets[bodyId];
                    const zodiac = this.getZodiacSign(result.longitude);
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${currentDate.toISOString().split('T')[0]}</td>
                        <td>${planet.name}</td>
                        <td>${result.longitude.toFixed(6)}°</td>
                        <td class="zodiac-${zodiac.name.toLowerCase()}">${zodiac.symbol}</td>
                        <td style="color: ${result.speedLong < 0 ? '#FF3B30' : '#4CD964'}">
                            ${result.speedLong.toFixed(4)}°/день
                        </td>
                        <td>${result.latitude.toFixed(4)}°</td>
                        <td>${result.distance.toFixed(6)}</td>
                    `;
                    tbody.appendChild(row);
                }
            }
            
        } catch (error) {
            console.error('Error calculating ephemeris:', error);
            alert(`Ошибка расчета эфемерид: ${error.message}`);
        } finally {
            document.getElementById('ephemLoading').style.display = 'none';
        }
    }
    
    getZodiacSign(longitude) {
        const normalized = ((longitude % 360) + 360) % 360;
        
        for (const sign of this.zodiac) {
            if (normalized >= sign.start && normalized < sign.end) {
                const degree = normalized - sign.start;
                const degInt = Math.floor(degree);
                const min = Math.floor((degree - degInt) * 60);
                const sec = Math.floor(((degree - degInt) * 60 - min) * 60);
                
                return {
                    name: sign.name,
                    symbol: sign.symbol,
                    degree: degInt,
                    minute: min,
                    second: sec,
                    decimal: degree
                };
            }
        }
        
        // Fallback
        return {
            name: "Овен",
            symbol: "♈",
            degree: 0,
            minute: 0,
            second: 0,
            decimal: 0
        };
    }
    
    formatPosition(longitude) {
        const zodiac = this.getZodiacSign(longitude);
        return `${zodiac.degree}° ${zodiac.minute}' ${zodiac.symbol}`;
    }
    
    saveSettings() {
        const settings = {
            algorithm: document.getElementById('calcAlgorithm').value,
            precision: document.getElementById('calcPrecision').value,
            ephemFile: document.getElementById('ephemFile').value,
            language: document.getElementById('interfaceLanguage').value,
            exportFormat: document.getElementById('exportFormat').value,
            geoData: document.getElementById('geoData').value,
            cacheSize: document.getElementById('cacheSize').value,
            savedAt: new Date().toISOString()
        };
        
        localStorage.setItem('astroProSettings', JSON.stringify(settings));
        alert('Настройки сохранены успешно!');
    }
    
    clearCache() {
        if (confirm('Очистить кэш WASM и перезагрузить Swiss Ephemeris?')) {
            localStorage.removeItem('astroProSettings');
            this.swiss.initialized = false;
            this.initialize();
        }
    }
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', () => {
    window.astroPro = new ProfessionalAstroCalculator();
    setTimeout(() => window.astroPro.initialize(), 100);
});
    </script>
    
    <!-- Font Awesome -->
    <script>
        document.head.insertAdjacentHTML('beforeend', `
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        `);
    </script>
</body>
</html>
